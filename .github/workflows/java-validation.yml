name: Java Curriculum Validation

on:
  push:
    branches: [main, master]
    paths:
      - 'src/data/java/**'
      - 'src/lib/pistonApi.ts'
      - 'scripts/validate-java-solutions.ts'
  pull_request:
    branches: [main, master]
    paths:
      - 'src/data/java/**'
      - 'src/lib/pistonApi.ts'
      - 'scripts/validate-java-solutions.ts'
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate-structure:
    name: Validate Solution Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run structure tests
        run: npx vitest run src/data/java/__tests__/curriculum-solutions.test.ts --reporter=verbose
        env:
          CI: true
          # Skip API tests in structure validation job
          TEST_PISTON_API: false

  validate-api:
    name: Validate Against Piston API
    runs-on: ubuntu-latest
    # Only run on push to main, not on every PR (to save API calls)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate Java solutions against Piston API
        run: npx tsx scripts/validate-java-solutions.ts
        timeout-minutes: 15
      
      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: java-validation-results
          path: |
            validation-results.json
          if-no-files-found: ignore
          retention-days: 7

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate-structure, validate-api]
    if: failure()
    steps:
      - name: Create failure summary
        run: |
          echo "## âŒ Java Curriculum Validation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more Java solutions failed validation." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the job logs for detailed error messages" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`npm run validate:java\` locally to debug" >> $GITHUB_STEP_SUMMARY
          echo "3. Fix the failing solutions in \`src/data/java/curriculum.ts\`" >> $GITHUB_STEP_SUMMARY
